name: FlowGrid CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_REGISTRY: vikaskakarla
  FRONTEND_IMAGE: vikaskakarla/flowgrid-frontend
  BACKEND_IMAGE: vikaskakarla/flowgrid-backend
  EC2_HOST: 13.62.224.81
  EC2_USER: ubuntu

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install frontend dependencies
      run: npm ci
      
    - name: Install backend dependencies
      run: |
        cd server
        npm ci
        
    - name: Run frontend linting
      run: npm run lint || echo "Linting completed with warnings"
      continue-on-error: true
      
    - name: Run TypeScript type checking
      run: npm run typecheck || echo "Type checking completed with warnings"
      continue-on-error: true
      
    - name: Build frontend
      run: |
        export VITE_API_URL=http://${{ env.EC2_HOST }}:5000/api
        npm run build
        
    - name: Build backend
      run: |
        cd server
        npm run build
        
    - name: Run frontend tests
      run: npm run test:unit || echo "Frontend tests completed"
      continue-on-error: true
      
    - name: Run backend tests
      run: |
        cd server
        npm test || echo "Backend tests completed"
      continue-on-error: true

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.frontend
        push: true
        tags: |
          ${{ env.FRONTEND_IMAGE }}:latest
          ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
        build-args: |
          VITE_API_URL=http://${{ env.EC2_HOST }}:5000/api
          
    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./server
        push: true
        tags: |
          ${{ env.BACKEND_IMAGE }}:latest
          ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Update system
          sudo apt-get update -y
          
          # Install Docker if not present
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker ubuntu
          fi
          
          # Install Docker Compose if not present
          if ! command -v docker-compose &> /dev/null; then
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Create directories
          mkdir -p /home/ubuntu/docker
          
          # Create docker-compose.yml
          cat > /home/ubuntu/docker-compose.yml << 'COMPOSE_EOF'
          services:
            mongodb:
              image: mongo:7.0
              restart: unless-stopped
              environment:
                MONGO_INITDB_ROOT_USERNAME: admin
                MONGO_INITDB_ROOT_PASSWORD: FlowGrid2024SecurePassword!
              volumes:
                - mongodb_data:/data/db
                - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
              networks:
                - app-network
              ports:
                - "27017:27017"
              healthcheck:
                test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
                interval: 30s
                timeout: 10s
                retries: 3

            backend:
              image: vikaskakarla/flowgrid-backend:latest
              restart: unless-stopped
              environment:
                MONGODB_URI: mongodb://admin:FlowGrid2024SecurePassword!@mongodb:27017/flowgrid?authSource=admin
                JWT_SECRET: FlowGrid2024SuperSecureJWTSecretKey123456789!
                PORT: 5000
                NODE_ENV: production
                CORS_ORIGIN: http://13.62.224.81
              ports:
                - "5000:5000"
              depends_on:
                mongodb:
                  condition: service_healthy
              networks:
                - app-network
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s

            frontend:
              image: vikaskakarla/flowgrid-frontend:latest
              restart: unless-stopped
              ports:
                - "80:80"
              depends_on:
                backend:
                  condition: service_healthy
              networks:
                - app-network
              volumes:
                - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s

          volumes:
            mongodb_data:
              driver: local

          networks:
            app-network:
              driver: bridge
          COMPOSE_EOF
          
          # Create nginx.conf
          cat > /home/ubuntu/docker/nginx.conf << 'NGINX_EOF'
          server {
              listen 80;
              server_name localhost;
              
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/javascript;
              
              location / {
                  root /usr/share/nginx/html;
                  index index.html index.htm;
                  try_files $uri $uri/ /index.html;
                  
                  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              location /api/ {
                  proxy_pass http://backend:5000/api/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
                  
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }
              
              location /health {
                  proxy_pass http://backend:5000/health;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
              }
          }
          NGINX_EOF
          
          # Create mongo-init.js
          cat > /home/ubuntu/docker/mongo-init.js << 'MONGO_EOF'
          db = db.getSiblingDB('flowgrid');
          
          db.createUser({
            user: 'flowgrid_user',
            pwd: 'flowgrid_password',
            roles: [{ role: 'readWrite', db: 'flowgrid' }]
          });
          
          db.createCollection('users');
          db.createCollection('products');
          db.createCollection('orders');
          db.createCollection('customers');
          db.createCollection('inventory');
          
          db.users.createIndex({ "email": 1 }, { unique: true });
          db.users.createIndex({ "username": 1 }, { unique: true });
          db.products.createIndex({ "sku": 1 }, { unique: true });
          db.orders.createIndex({ "orderNumber": 1 }, { unique: true });
          db.customers.createIndex({ "email": 1 }, { unique: true });
          
          print('Database initialized successfully!');
          MONGO_EOF
          
          # Pull latest images
          docker pull ${{ env.FRONTEND_IMAGE }}:latest
          docker pull ${{ env.BACKEND_IMAGE }}:latest
          
          # Stop existing containers
          docker-compose down || true
          
          # Remove old volumes to ensure fresh database
          docker volume prune -f || true
          
          # Start new deployment
          docker-compose up -d
          
          # Wait for services to start
          sleep 10
          
          # Show container status
          docker-compose ps
          
          # Show logs
          docker-compose logs --tail=50
          
          # Clean up old images
          docker image prune -f
          
    - name: Verify Deployment
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "ðŸŒ Frontend: http://${{ env.EC2_HOST }}"
        echo "ðŸ”— Backend API: http://${{ env.EC2_HOST }}:5000"
        echo ""
        echo "Note: Services may take 1-2 minutes to fully start"