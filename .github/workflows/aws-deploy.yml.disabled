name: Deploy to AWS EC2

on:
  workflow_dispatch:  # Only run manually until secrets are configured

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if secrets are configured
      id: check_secrets
      run: |
        if [ -z "${{ secrets.AWS_EC2_HOST }}" ]; then
          echo "configured=false" >> $GITHUB_OUTPUT
          echo "⚠️  AWS secrets not configured"
        else
          echo "configured=true" >> $GITHUB_OUTPUT
          echo "✅ AWS secrets configured"
        fi
    
    - name: Deploy to EC2 via SSH
      if: steps.check_secrets.outputs.configured == 'true'
      env:
        AWS_EC2_HOST: ${{ secrets.AWS_EC2_HOST }}
        AWS_EC2_USER: ${{ secrets.AWS_EC2_USER }}
        AWS_SSH_KEY: ${{ secrets.AWS_SSH_KEY }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$AWS_SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $AWS_EC2_HOST >> ~/.ssh/known_hosts
        
        # Trigger deployment on EC2
        ssh -i ~/.ssh/deploy_key $AWS_EC2_USER@$AWS_EC2_HOST 'bash -s' < deploy-to-aws.sh
        
        echo "✅ Deployment triggered successfully!"
    
    - name: Deployment skipped
      if: steps.check_secrets.outputs.configured == 'false'
      run: |
        echo "⚠️  AWS deployment skipped - secrets not configured"
        echo ""
        echo "To enable AWS deployment, add these secrets to your repository:"
        echo "  Settings → Secrets and variables → Actions → New repository secret"
        echo ""
        echo "Required secrets:"
        echo "  - AWS_EC2_HOST: Your EC2 public IP address"
        echo "  - AWS_EC2_USER: ubuntu"
        echo "  - AWS_SSH_KEY: Contents of your .pem key file"
        echo ""
        echo "After configuring secrets, you can enable automatic deployment by adding:"
        echo "  on:"
        echo "    push:"
        echo "      branches: [ main ]"
