name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to EC2
      env:
        AWS_EC2_HOST: ${{ secrets.AWS_EC2_HOST }}
        AWS_EC2_USER: ${{ secrets.AWS_EC2_USER }}
        AWS_SSH_KEY: ${{ secrets.AWS_SSH_KEY }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$AWS_SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $AWS_EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "ðŸš€ Deploying to EC2..."
        
        # Deploy using the complete deployment script
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $AWS_EC2_USER@$AWS_EC2_HOST 'bash -s' << 'ENDSSH'
          # Download and run complete deployment script
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/deploy-complete.sh -o /tmp/deploy-complete.sh
          chmod +x /tmp/deploy-complete.sh
          /tmp/deploy-complete.sh
        ENDSSH
        
        echo ""
        echo "âœ… Deployment completed!"
        echo "ðŸŒ Application: http://$AWS_EC2_HOST"
        echo "ðŸ”Œ API: http://$AWS_EC2_HOST/api"
