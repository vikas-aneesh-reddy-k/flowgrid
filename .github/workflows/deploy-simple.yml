name: ‚úÖ Deploy to EC2 (Simple & Working)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        command_timeout: 45m
        script: |
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # Free up memory first
          echo "üßπ Cleaning up..."
          docker system prune -af || true
          
          # Navigate to app directory
          cd /home/ubuntu/flowgrid || mkdir -p /home/ubuntu/flowgrid && cd /home/ubuntu/flowgrid
          
          # Pull latest code
          echo "üì• Pulling latest code..."
          if [ -d ".git" ]; then
            git fetch origin main
            git reset --hard origin/main
          else
            git clone ${{ secrets.REPO_URL }} .
          fi
          
          # Create/update .env file
          cat > .env << EOF
          MONGO_USER=admin
          MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
          MONGODB_URI=mongodb://admin:${{ secrets.MONGO_PASSWORD }}@mongodb:27017/flowgrid?authSource=admin
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          NODE_ENV=production
          PORT=5000
          CORS_ORIGIN=*
          VITE_API_URL=http://${{ secrets.EC2_HOST }}/api
          EOF
          
          # Stop old containers to free memory
          echo "üõë Stopping old containers..."
          docker compose down || docker-compose down || true
          
          # Pull MongoDB first (it's cached usually)
          echo "üì• Pulling MongoDB..."
          docker pull mongo:7.0
          
          # Build and start with increased timeout
          echo "üî® Building containers (this will take 10-15 minutes on t3.micro)..."
          export COMPOSE_HTTP_TIMEOUT=1800
          export DOCKER_CLIENT_TIMEOUT=1800
          export DOCKER_BUILDKIT=1
          
          # Build one at a time to avoid memory issues
          echo "Building backend..."
          docker compose build backend || docker-compose build backend
          
          echo "Building frontend (this is slow on t3.micro, please wait)..."
          docker compose build frontend || docker-compose build frontend
          
          # Start all services
          echo "üöÄ Starting all containers..."
          docker compose up -d || docker-compose up -d
          
          # Wait for services
          echo "‚è≥ Waiting for services to start..."
          sleep 30
          
          # Health check with retries
          echo "üè• Running health checks..."
          for i in {1..20}; do
            if curl -f http://localhost/api/health 2>/dev/null; then
              echo "‚úÖ Backend is healthy!"
              break
            else
              echo "‚è≥ Waiting for backend... attempt $i/20"
              sleep 10
            fi
          done
          
          # Final status
          echo ""
          echo "‚úÖ Deployment complete!"
          echo "üåê Application: http://${{ secrets.EC2_HOST }}"
          echo ""
          docker ps
          echo ""
          docker compose logs --tail=20 backend
