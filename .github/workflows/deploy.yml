name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy Application
      run: |
        set -e
        
        echo "ðŸš€ Starting deployment..."
        
        # Get EC2 IP
        EC2_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
        
        # Build and deploy frontend
        echo "ðŸŽ¨ Building frontend..."
        npm install
        echo "VITE_API_URL=http://${EC2_IP}/api" > .env.production
        npm run build
        
        echo "ðŸ“¦ Deploying frontend..."
        sudo rm -rf /var/www/flowgrid
        sudo mkdir -p /var/www/flowgrid
        sudo cp -r dist/* /var/www/flowgrid/
        sudo chown -R www-data:www-data /var/www/flowgrid
        
        # Build and deploy backend
        echo "ðŸ”§ Building backend..."
        cd server
        npm install
        npm run build
        
        # Update backend .env
        if [ ! -f .env ]; then
          JWT_SECRET=$(openssl rand -base64 32)
          cat > .env << EOF
        PORT=5000
        MONGODB_URI=${{ secrets.MONGODB_URI }}
        JWT_SECRET=${JWT_SECRET}
        NODE_ENV=production
        CORS_ORIGIN=http://${EC2_IP}
        EOF
        fi
        
        # Restart services
        echo "ðŸ”„ Restarting services..."
        pm2 restart flowgrid-backend || pm2 start dist/index.js --name flowgrid-backend
        pm2 save
        
        sudo systemctl restart nginx
        
        # Verify
        sleep 3
        echo ""
        echo "âœ… Deployment complete!"
        echo "ðŸŒ Application: http://${EC2_IP}"
        echo ""
        pm2 status
        curl -f http://localhost/api/health || echo "âš ï¸ Health check failed"
