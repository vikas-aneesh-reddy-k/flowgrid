name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies and build
      run: |
        npm install
        npm run build

    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_EC2_HOST }}
        username: ${{ secrets.AWS_EC2_USER }}
        key: ${{ secrets.AWS_SSH_KEY }}
        script: |
          cd ~/flowgrid || mkdir -p ~/flowgrid
          
          # Pull latest code
          if [ -d ".git" ]; then
            git pull origin main
          else
            git clone https://github.com/${{ github.repository }} .
          fi
          
          # Install and build frontend
          npm install
          npm run build
          
          # Install and restart backend
          cd server
          npm install
          
          # Setup environment if not exists
          if [ ! -f .env ]; then
            echo "MONGODB_URI=mongodb://localhost:27017/flowgrid" > .env
            echo "JWT_SECRET=$(openssl rand -base64 32)" >> .env
            echo "PORT=5000" >> .env
          fi
          
          # Restart backend with PM2
          pm2 delete flowgrid-backend || true
          pm2 start src/index.ts --name flowgrid-backend --interpreter ts-node
          pm2 save
          
          # Copy frontend build to nginx
          cd ..
          sudo rm -rf /var/www/flowgrid
          sudo mkdir -p /var/www/flowgrid
          sudo cp -r dist/* /var/www/flowgrid/
          
          # Restart nginx
          sudo systemctl restart nginx
          
          echo "Deployment completed successfully!"
